<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ã²ã‹ã‚Šã¡ã‚ƒã‚“ã®ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ ã€œç®±ã®ä¸­ã®ç§˜å¯†ã€œ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;touch-action:manipulation;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
body{font-family:'Hiragino Sans','Meiryo','Yu Gothic',sans-serif;background:#000}
#game{position:relative;width:100%;height:100%;overflow:hidden}

/* ===== SCREENS ===== */
.screen{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center}

/* Title */
#title-screen{background:linear-gradient(180deg,#87CEEB,#98FB98);z-index:100}
#title-screen h1{font-size:clamp(1.2rem,5vw,2rem);text-align:center;color:#333;margin-bottom:0.3em;text-shadow:2px 2px 0 #fff;line-height:1.4}
#title-screen .sub{font-size:clamp(0.9rem,3vw,1.3rem);color:#666;margin-bottom:1.2em}
#title-screen .emojis{font-size:2.5rem;margin-bottom:0.8em}
.btn{padding:12px 32px;font-size:1.1rem;border:none;border-radius:25px;cursor:pointer;font-family:inherit;transition:transform 0.1s}
.btn:active{transform:scale(0.95)}
.btn-primary{background:#FF6B9D;color:#fff;box-shadow:0 4px 0 #CC5580}
.btn-primary:active{box-shadow:0 2px 0 #CC5580;transform:translateY(2px) scale(0.98)}
.btn-secondary{background:#4ECDC4;color:#fff;box-shadow:0 4px 0 #3BA89F;margin:5px}

/* HUD - always on top when visible */
#hud{position:absolute;top:0;left:0;right:0;z-index:40;display:none;padding:8px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0));pointer-events:none}
#hud *{pointer-events:auto}
#hud-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px}
.hud-tag{background:rgba(0,0,0,0.5);color:#fff;padding:3px 8px;border-radius:8px;font-size:clamp(0.65rem,2.2vw,0.8rem);white-space:nowrap}
#hud-exp-bar{width:100%;height:8px;background:rgba(255,255,255,0.15);border-radius:4px;margin-top:5px;overflow:hidden}
#hud-exp-fill{height:100%;width:0%;background:linear-gradient(90deg,#FFD700,#FFA500);border-radius:4px;transition:width 0.3s}
#hud-mission{background:rgba(0,0,0,0.5);color:#FFD700;text-align:center;padding:5px 10px;border-radius:8px;margin-top:5px;font-size:clamp(0.6rem,2vw,0.8rem);line-height:1.4}

/* Floating EXP popup */
.exp-popup{position:fixed;left:50%;transform:translateX(-50%);color:#FFD700;font-weight:bold;font-size:1.2rem;z-index:200;pointer-events:none;animation:expFloat 1.2s ease-out forwards;text-shadow:0 0 6px rgba(0,0,0,0.8)}
@keyframes expFloat{0%{opacity:1;top:40%}100%{opacity:0;top:20%}}

/* Dialogue */
#dialogue{position:absolute;bottom:70px;left:4%;right:4%;background:rgba(255,255,255,0.95);border-radius:15px;padding:12px 16px;font-size:clamp(0.85rem,3vw,1.1rem);color:#333;z-index:50;display:none;box-shadow:0 4px 15px rgba(0,0,0,0.2);line-height:1.6}
#dialogue .speaker{font-weight:bold;color:#FF6B9D;margin-bottom:2px}
#dialogue .tap-hint{font-size:0.65em;color:#aaa;text-align:right;margin-top:2px}

/* Field */
#field{position:absolute;inset:0;display:none;overflow:hidden}
#field-bg{position:absolute;inset:0}
.field-tile{position:absolute;font-size:1.5rem;pointer-events:none}
.field-entity{position:absolute;cursor:pointer;transition:left 0.12s,top 0.12s;z-index:10}
#player{font-size:2.2rem;z-index:20}
#pet-follow{font-size:1.8rem;z-index:19;display:none}
.animal-entity{font-size:2.5rem;z-index:10;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.hidden-door{display:none;font-size:2.5rem;z-index:15;animation:doorGlow 2s infinite}
@keyframes doorGlow{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5) drop-shadow(0 0 10px #ff0)}}
@keyframes eyeBlink{0%,45%,55%,100%{opacity:0}50%{opacity:1}}

/* D-Pad */
#dpad{position:absolute;bottom:10px;left:15px;z-index:60;display:none}
#dpad button{position:absolute;width:52px;height:52px;border:none;border-radius:13px;background:rgba(255,255,255,0.55);font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
#dpad button:active{background:rgba(255,255,255,0.85)}
#dpad-up{left:52px;top:0}
#dpad-down{left:52px;top:104px}
#dpad-left{left:0;top:52px}
#dpad-right{left:104px;top:52px}
#action-btn{position:absolute;bottom:55px;right:18px;width:64px;height:64px;border:none;border-radius:50%;background:rgba(255,107,157,0.75);color:#fff;font-size:0.75rem;font-weight:bold;cursor:pointer;z-index:60;display:none;box-shadow:0 3px 0 rgba(200,50,100,0.5)}

/* Pet Select */
#pet-select{background:rgba(255,255,255,0.97);z-index:70}
#pet-select h2{margin-bottom:15px;color:#333;font-size:clamp(1rem,4vw,1.5rem)}
.pet-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:10px}
.pet-option{display:flex;flex-direction:column;align-items:center;padding:14px;border-radius:15px;border:3px solid #eee;cursor:pointer;background:#fff;transition:all 0.2s;width:clamp(80px,20vw,110px)}
.pet-option:active{border-color:#FF6B9D;transform:scale(1.05)}
.pet-option .emoji{font-size:2.8rem}
.pet-option .name{font-size:0.85rem;color:#333;margin-top:4px}
.pet-option .type{font-size:0.65rem;color:#888}

/* Battle */
#battle{z-index:70}
#battle-bg{position:absolute;inset:0;background:linear-gradient(180deg,#1a1a2e,#16213e,#0f3460)}
.battle-entity{display:flex;align-items:center;margin-bottom:10px;position:relative;z-index:1}
.battle-entity .emoji{font-size:3rem;margin-right:10px}
.battle-entity .info{flex:1}
.battle-entity .name{color:#fff;font-weight:bold;font-size:0.9rem}
.hp-bar{width:100%;height:12px;background:rgba(255,255,255,0.2);border-radius:6px;overflow:hidden;margin-top:4px}
.hp-fill{height:100%;background:linear-gradient(90deg,#4CAF50,#8BC34A);border-radius:6px;transition:width 0.5s}
.hp-fill.low{background:linear-gradient(90deg,#f44336,#ff5722)}
.hp-text{color:#ccc;font-size:0.75rem;margin-top:2px}
#battle-top{position:relative;z-index:1;padding:15px;width:100%}
#battle-bottom{position:relative;z-index:1;padding:15px;margin-top:auto;width:100%}
#battle-msg{color:#fff;text-align:center;font-size:1rem;padding:15px;min-height:50px;position:relative;z-index:1}
#battle-actions{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;position:relative;z-index:1;padding:8px}
.battle-btn{padding:10px 20px;font-size:0.95rem;border:none;border-radius:12px;cursor:pointer;color:#fff;font-family:inherit;min-width:120px}
.battle-btn:active{transform:scale(0.95)}
.battle-btn.atk{background:#e74c3c}
.battle-btn.special{background:#9b59b6}

/* Bike */
#bike-scene{z-index:70;display:none;position:absolute;inset:0;overflow:hidden}
#bike-road{position:absolute;bottom:0;left:0;right:0;height:40%}
#bike-player{position:absolute;font-size:2.5rem;z-index:10;transition:top 0.15s}
.bike-obstacle{position:absolute;font-size:2rem;z-index:5}
#bike-distance{position:absolute;top:60px;right:10px;color:#fff;font-size:0.9rem;background:rgba(0,0,0,0.4);padding:4px 10px;border-radius:8px;z-index:20}
#bike-lane-btns{position:absolute;bottom:20px;left:0;right:0;display:flex;justify-content:center;gap:20px;z-index:20}
#bike-lane-btns button{width:65px;height:65px;border:none;border-radius:50%;background:rgba(255,255,255,0.5);font-size:1.5rem;cursor:pointer}

/* Mini Event */
#mini-event{z-index:70}
#mini-event-content{text-align:center;color:#fff;padding:20px}
#mini-event-content h2{font-size:1.3rem;margin-bottom:15px}

/* Garden */
#garden{z-index:70}
#garden-content{text-align:center;width:100%;padding:20px}

/* Birthday */
#birthday{z-index:70}
#birthday-content{text-align:center;padding:20px}
.candle{font-size:3rem;display:inline-block;animation:candleFlicker 0.3s infinite alternate}
@keyframes candleFlicker{from{transform:scaleY(1)}to{transform:scaleY(1.1)}}
#present-box{font-size:6rem;cursor:pointer;display:inline-block;animation:boxBounce 1s infinite}
@keyframes boxBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

/* Horror */
#horror-overlay{position:absolute;inset:0;background:rgba(139,0,0,0);z-index:75;pointer-events:none;transition:background 2s}
#horror-overlay.active{background:rgba(139,0,0,0.6);pointer-events:auto}

/* Escape */
#escape{z-index:70;background:#0a0a0a}
#escape-runner{position:absolute;bottom:30%;left:20%;font-size:2.5rem;z-index:10;animation:runBounce 0.3s infinite alternate}
@keyframes runBounce{from{transform:translateY(0)}to{transform:translateY(-5px)}}
.escape-eye{position:absolute;font-size:1.5rem;z-index:5;animation:eyeBlink 3s infinite;opacity:0}

/* Loop Message */
#loop-msg{z-index:80;background:#000;color:#fff;text-align:center;padding:20px}
#loop-msg p{font-size:1.1rem;margin-bottom:15px;line-height:1.8}

/* True Ending */
#true-ending{z-index:90;padding:20px;text-align:center;overflow-y:auto}
#true-ending h2{font-size:1.3rem;margin-bottom:15px}
#true-ending p{font-size:1rem;margin-bottom:10px;line-height:1.8}

/* Letter */
#letter-screen{background:rgba(0,0,0,0.9);z-index:85;padding:20px}
#letter-content{background:#f5f0e0;color:#333;padding:25px;border-radius:10px;max-width:350px;font-size:0.95rem;line-height:1.8;margin-bottom:20px;box-shadow:0 5px 30px rgba(0,0,0,0.5)}
#letter-choices{display:flex;flex-direction:column;gap:10px}

/* Wait counter */
#wait-counter{z-index:75;background:rgba(0,0,0,0.85);color:#fff;text-align:center}
#wait-counter .timer{font-size:3rem;margin:20px 0}

/* Confetti */
.confetti{position:absolute;width:8px;height:8px;z-index:100;pointer-events:none;animation:confettiFall 2s linear forwards}
@keyframes confettiFall{from{transform:translateY(-20px) rotate(0deg);opacity:1}to{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* Transition */
#transition{position:absolute;inset:0;background:#000;z-index:95;display:none;opacity:0;transition:opacity 0.8s}
#transition.active{opacity:1}
</style>
</head>
<body>
<div id="game">

<div id="title-screen" class="screen" style="display:flex">
  <div class="emojis">ğŸ±ğŸ•ğŸ°ğŸ»âœ¨</div>
  <h1>ã²ã‹ã‚Šã¡ã‚ƒã‚“ã®<br>ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼</h1>
  <div class="sub">ã€œç®±ã®ä¸­ã®ç§˜å¯†ã€œ</div>
  <button class="btn btn-primary" id="start-btn">ã¯ã˜ã‚ã‚‹</button>
</div>

<div id="hud">
  <div id="hud-row">
    <span class="hud-tag" id="hud-level">Lv.1</span>
    <span class="hud-tag" id="hud-exp">EXP 0/10</span>
    <span class="hud-tag" id="hud-pet" style="display:none"></span>
    <span class="hud-tag" id="hud-phase">ãƒ•ã‚§ãƒ¼ã‚º1</span>
    <span class="hud-tag" id="hud-loop" style="display:none"></span>
  </div>
  <div id="hud-exp-bar"><div id="hud-exp-fill"></div></div>
  <div id="hud-mission">ğŸ¯ ãƒšãƒƒãƒˆã‚’ãˆã‚‰ã¼ã†ï¼</div>
</div>

<div id="field">
  <div id="field-bg"></div>
  <div id="player" class="field-entity">ğŸ‘§</div>
  <div id="pet-follow" class="field-entity"></div>
  <div id="hidden-door" class="field-entity hidden-door">ğŸšª</div>
</div>

<div id="dialogue">
  <div class="speaker"></div>
  <div class="text"></div>
  <div class="tap-hint">â–¼ ã‚¿ãƒƒãƒ—ã§æ¬¡ã¸</div>
</div>

<div id="dpad">
  <button id="dpad-up">â–²</button>
  <button id="dpad-down">â–¼</button>
  <button id="dpad-left">â—€</button>
  <button id="dpad-right">â–¶</button>
</div>
<button id="action-btn">ã¯ãªã™</button>

<div id="pet-select" class="screen">
  <h2>ãƒšãƒƒãƒˆã‚’ãˆã‚‰ã¼ã†ï¼</h2>
  <div class="pet-grid">
    <div class="pet-option" data-pet="cat"><div class="emoji">ğŸ±</div><div class="name">ã­ã“</div><div class="type">ã™ã°ã‚„ã•å‹</div></div>
    <div class="pet-option" data-pet="dog"><div class="emoji">ğŸ•</div><div class="name">ã„ã¬</div><div class="type">ãƒãƒ©ãƒ³ã‚¹å‹</div></div>
    <div class="pet-option" data-pet="rabbit"><div class="emoji">ğŸ°</div><div class="name">ã†ã•ã</div><div class="type">ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯å‹</div></div>
    <div class="pet-option" data-pet="bear"><div class="emoji">ğŸ»</div><div class="name">ãã¾</div><div class="type">ãƒ‘ãƒ¯ãƒ¼å‹</div></div>
  </div>
</div>

<div id="battle" class="screen">
  <div id="battle-bg"></div>
  <div id="battle-top">
    <div class="battle-entity"><div class="emoji" id="enemy-emoji"></div><div class="info"><div class="name" id="enemy-name"></div><div class="hp-bar"><div class="hp-fill" id="enemy-hp"></div></div><div class="hp-text" id="enemy-hp-text"></div></div></div>
  </div>
  <div id="battle-msg"></div>
  <div id="battle-bottom">
    <div class="battle-entity"><div class="emoji" id="pet-emoji"></div><div class="info"><div class="name" id="pet-name"></div><div class="hp-bar"><div class="hp-fill" id="pet-hp"></div></div><div class="hp-text" id="pet-hp-text"></div></div></div>
    <div id="battle-actions"></div>
  </div>
</div>

<div id="bike-scene">
  <div id="bike-road"></div>
  <div id="bike-player">ğŸï¸ğŸ‘§</div>
  <div id="bike-distance"></div>
  <div id="bike-lane-btns"><button id="bike-up">â–²</button><button id="bike-down">â–¼</button></div>
</div>

<div id="mini-event" class="screen"><div id="mini-event-content"></div></div>
<div id="wait-counter" class="screen">
  <h2 style="font-size:1.2rem">ã‚†ãªã¡ã‚ƒã‚“ã®å®¶ã§ ã¾ã£ã¦ã„ã¾ã™â€¦</h2>
  <div class="timer" id="wait-timer">5</div>
  <p style="font-size:0.9rem">å¤‰èº«ã®åŠ›ãŒ ãŸã¾ã£ã¦ã„ã¾ã™âœ¨</p>
</div>
<div id="garden" class="screen"><div id="garden-content"></div></div>
<div id="birthday" class="screen"><div id="birthday-content"></div></div>
<div id="horror-overlay"></div>
<div id="escape" class="screen"><div id="escape-runner">ğŸƒâ€â™€ï¸</div></div>
<div id="loop-msg" class="screen"></div>
<div id="letter-screen" class="screen"><div id="letter-content"></div><div id="letter-choices"></div></div>
<div id="true-ending" class="screen"></div>
<div id="transition"></div>

</div>
<script>
// ============================================================
// GAME STATE
// ============================================================
const G = {
  loop:0, phase:0, level:1, exp:0, expNext:10,
  pet:null, petHP:0, petMaxHP:0, team:[], friends:[],
  transformed:false, canTransform:false,
  defeatedMonsters:[], playerX:5, playerY:4,
  fieldW:11, fieldH:8, entities:[],
  petSelected:false,
  bikeLane:1, bikeDistance:0, bikeTarget:100, bikeSection:0,
  bikeObstacles:[], bikeRunning:false,
  battleActive:false, currentEnemy:null, enemyHP:0, enemyMaxHP:0,
  dialogueQueue:[], dialogueCallback:null,
  moveInterval:null, audioCtx:null, lastBgm:null,
  _dodgeNext:false, _talkCooldown:false,
};

// ============================================================
// AUDIO
// ============================================================
function initAudio(){if(G.audioCtx)return;G.audioCtx=new(window.AudioContext||window.webkitAudioContext)()}
function playNote(f,d,t='sine',v=0.15){if(!G.audioCtx)return;const o=G.audioCtx.createOscillator(),g=G.audioCtx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;g.gain.exponentialRampToValueAtTime(0.001,G.audioCtx.currentTime+d);o.connect(g);g.connect(G.audioCtx.destination);o.start();o.stop(G.audioCtx.currentTime+d)}
function playSfx(n){
  initAudio();
  switch(n){
    case'tap':playNote(800,0.1,'sine',0.1);break;
    case'select':playNote(523,0.1);setTimeout(()=>playNote(659,0.1),80);setTimeout(()=>playNote(784,0.15),160);break;
    case'hit':playNote(200,0.15,'sawtooth',0.15);break;
    case'heal':playNote(523,0.15);setTimeout(()=>playNote(659,0.15),100);setTimeout(()=>playNote(784,0.2),200);break;
    case'victory':[523,659,784,1047].forEach((f,i)=>setTimeout(()=>playNote(f,0.3),i*150));break;
    case'levelup':[440,554,659,880].forEach((f,i)=>setTimeout(()=>playNote(f,0.25,'triangle'),i*120));break;
    case'heartbeat':playNote(60,0.4,'sine',0.3);setTimeout(()=>playNote(55,0.3,'sine',0.25),200);break;
    case'crash':playNote(100,0.3,'sawtooth',0.2);playNote(150,0.2,'square',0.15);break;
    case'door':playNote(300,0.2,'square',0.1);setTimeout(()=>playNote(400,0.3,'square',0.1),150);break;
  }
}
let bgmInterval=null;
function startBGM(type){
  stopBGM();initAudio();G.lastBgm=type;
  const tm=1-G.loop*0.03,pm=1-G.loop*0.02;
  const patterns={
    field:{notes:[523,587,659,698,784,698,659,587],ms:350,t:'sine',v:0.06,bass:262},
    battle:{notes:[330,392,440,494,440,392,330,262],ms:200,t:'square',v:0.05,bass:165},
    bike:{notes:[440,523,587,659,587,523],ms:180,t:'sawtooth',v:0.05},
    garden:{notes:[392,440,494,523,494,440,392,349],ms:500,t:'sine',v:0.05},
    birthday:{notes:[262,262,294,262,349,330,262,262,294,262,392,349],ms:400,t:'sine',v:0.07},
    escape:{notes:[80,90,75,85,70,95],ms:600,t:'sawtooth',v:0.04},
  };
  const p=patterns[type];if(!p)return;
  let i=0;
  bgmInterval=setInterval(()=>{
    playNote(p.notes[i%p.notes.length]*pm,p.ms/1000*1.5,p.t,p.v);
    if(p.bass&&i%2===0)playNote(p.bass*pm,p.ms/1000*2,'triangle',0.04);
    i++;
  },p.ms/tm);
}
function stopBGM(){if(bgmInterval){clearInterval(bgmInterval);bgmInterval=null}G.lastBgm=null}

// ============================================================
// DOM HELPERS
// ============================================================
const $=id=>document.getElementById(id);
function show(id){$(id).style.display='flex'}
function hide(id){$(id).style.display='none'}
function showBlock(id){$(id).style.display='block'}

// ============================================================
// DATA
// ============================================================
const PETS={
  cat:{name:'ã­ã“',emoji:'ğŸ±',hp:30,atk:8,def:4,skill1:'ã­ã“ãƒ‘ãƒ³ãƒ',skill2:'ã™ã°ã‚„ã„å›é¿',s2type:'dodge'},
  dog:{name:'ã„ã¬',emoji:'ğŸ•',hp:35,atk:9,def:6,skill1:'ã‹ã¿ã¤ã',skill2:'é å ãˆ',s2type:'buff'},
  rabbit:{name:'ã†ã•ã',emoji:'ğŸ°',hp:28,atk:10,def:3,skill1:'ã‚¸ãƒ£ãƒ³ãƒ—ã‚­ãƒƒã‚¯',skill2:'ç©´æ˜ã‚Š',s2type:'dodge'},
  bear:{name:'ãã¾',emoji:'ğŸ»',hp:45,atk:12,def:8,skill1:'ãã¾ãƒ‘ãƒ³ãƒ',skill2:'ãƒã‚°',s2type:'heal'},
};
const MONSTERS=[
  {id:'baby',name:'ç›®ç‰ãƒ™ãƒ“ãƒ¼',emoji:'ğŸ‘ï¸',lvReq:2,hp:25,atk:6,def:3},
  {id:'king',name:'ç›®ç‰ã‚­ãƒ³ã‚°',emoji:'ğŸ‘ï¸ğŸ‘ï¸ğŸ‘ï¸',lvReq:4,hp:50,atk:10,def:5},
  {id:'dragon',name:'ç›®ç‰ãƒ‰ãƒ©ã‚´ãƒ³',emoji:'ğŸ‘ï¸ğŸ‰',lvReq:6,hp:80,atk:14,def:7},
];
const ANIMALS=[
  {emoji:'ğŸ±',msg:'ã«ã‚ƒãƒ¼ï¼',x:2,y:2},{emoji:'ğŸ•',msg:'ã‚ã‚“ï¼',x:8,y:2},
  {emoji:'ğŸ°',msg:'ã´ã‚‡ã‚“ï¼',x:3,y:5},{emoji:'ğŸ»',msg:'ãŒãŠãƒ¼',x:7,y:6},
  {emoji:'ğŸ¦',msg:'ãƒ”ãƒ”ãƒ”ï¼',x:1,y:3},{emoji:'ğŸ¸',msg:'ã‚±ãƒ­ã‚±ãƒ­ï¼',x:9,y:1},
  {emoji:'ğŸ¦Š',msg:'ã‚³ãƒ³ã‚³ãƒ³ï¼',x:5,y:7},
];
const LOOP_MSGS={
  3:['ã«ã‚ƒâ€¦ãƒ¼â€¦','ã‚â€¦ã‚“â€¦','ã´ã‚‡â€¦ã‚“â€¦','ãŒâ€¦ãŠãƒ¼â€¦','ãƒ”â€¦ãƒ”â€¦','ã‚±ãƒ­â€¦','ã‚³ãƒ³â€¦'],
  4:['ãƒ‹Ì¸ãƒ£Ì·ãƒ¼Ì´','ãƒ¯Ì¸ãƒ³Ì·','ãƒ”ãƒ§Ì¸ãƒ³Ì·','ã‚¬Ì¸ã‚ªÌ·ãƒ¼Ì´','â€¦','â€¦','â€¦'],
};

// ============================================================
// DIALOGUE
// ============================================================
function showDialogue(speaker,text,cb){
  const d=$('dialogue');d.style.display='block';
  d.querySelector('.speaker').textContent=speaker;
  d.querySelector('.text').textContent=text;
  G.dialogueCallback=cb||null;
}
function hideDialogue(){$('dialogue').style.display='none';G.dialogueCallback=null}
function dialogueSequence(msgs,finalCb){
  G.dialogueQueue=msgs.slice();
  function next(){
    if(G.dialogueQueue.length>0){const m=G.dialogueQueue.shift();showDialogue(m[0],m[1],next)}
    else{hideDialogue();if(finalCb)finalCb()}
  }
  next();
}
$('dialogue').addEventListener('click',()=>{playSfx('tap');if(G.dialogueCallback)G.dialogueCallback()});

// ============================================================
// TRANSITION & CONFETTI
// ============================================================
function transition(cb){
  const t=$('transition');t.style.display='block';t.style.opacity='0';
  requestAnimationFrame(()=>{t.classList.add('active');
    setTimeout(()=>{if(cb)cb();setTimeout(()=>{t.classList.remove('active');setTimeout(()=>t.style.display='none',800)},300)},800);
  });
}
function spawnConfetti(){
  const colors=['#FF6B9D','#4ECDC4','#FFE66D','#A8E6CF','#FF8B94','#B5EAD7'];
  for(let i=0;i<40;i++){const c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'%';c.style.top='-10px';c.style.background=colors[i%6];c.style.animationDelay=Math.random()+'s';c.style.borderRadius=Math.random()>0.5?'50%':'0';$('game').appendChild(c);setTimeout(()=>c.remove(),3000)}
}
function showExpPopup(amount){
  const el=document.createElement('div');el.className='exp-popup';el.textContent='+'+amount+' EXP';document.body.appendChild(el);setTimeout(()=>el.remove(),1300);
}

// ============================================================
// HUD
// ============================================================
function updateHUD(){
  $('hud-level').textContent='Lv.'+G.level;
  $('hud-exp').textContent='EXP '+G.exp+'/'+G.expNext;
  $('hud-exp-fill').style.width=(G.exp/G.expNext*100)+'%';
  if(G.pet){$('hud-pet').textContent=PETS[G.pet].emoji+PETS[G.pet].name;$('hud-pet').style.display=''}
  else $('hud-pet').style.display='none';
  const phaseNames={1:'ãƒ•ã‚§ãƒ¼ã‚º1 ğŸŒ¸',2:'ãƒãƒˆãƒ« âš”ï¸',3:'ãƒã‚¤ã‚¯ ğŸï¸',4:'ãŠã«ã‚ ğŸ¡',5:'ãŸã‚“ã˜ã‚‡ã†ã³ ğŸ‚'};
  $('hud-phase').textContent=phaseNames[G.phase]||'';
  if(G.loop>0){$('hud-loop').style.display='';$('hud-loop').textContent='ğŸ”„'+(G.loop+1)+'ã—ã‚…ã†ã‚'}
  updateMission();
}
function updateMission(){
  const m=$('hud-mission');if(!m)return;
  if(G.phase===1){
    if(!G.petSelected){m.textContent='ğŸ¯ ãƒšãƒƒãƒˆã‚’ãˆã‚‰ã¼ã†ï¼';return}
    const ready=MONSTERS.find(x=>G.level>=x.lvReq&&!G.defeatedMonsters.includes(x.id));
    if(ready){m.textContent='âš”ï¸ '+ready.name+'ãŒå‡ºç¾ï¼ ãƒãƒˆãƒ«ã«ããªãˆã‚ˆã†ï¼';return}
    const next=MONSTERS.find(x=>!G.defeatedMonsters.includes(x.id));
    if(next){
      const left=next.lvReq-G.level;
      const expLeft=left*10-G.exp;
      m.textContent='ğŸ¯ å‹•ç‰©ã«è©±ã—ã‹ã‘ã¦EXPã‚’ãŸã‚ã‚ˆã†ï¼ï¼ˆLv.'+next.lvReq+'ã¾ã§ã‚ã¨'+expLeft+'EXPï¼‰';
    }else m.textContent='ğŸ‰ å…¨æ€ªç£ã‚¯ãƒªã‚¢ï¼ æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸â€¦';
  }else if(G.phase===3){
    const d=['ã‚†ãªã¡ã‚ƒã‚“','ã¯ãªã¡ã‚ƒã‚“','ã²ãƒ¼ã¡ã‚ƒã‚“'][G.bikeSection]||'';
    m.textContent='ğŸï¸ '+d+'ã®ã¨ã“ã‚ã¸ï¼';
  }else if(G.phase===4)m.textContent='ğŸ¡ ã‚¿ãƒƒãƒ—é€£æ‰“ã§ã‹ã‘ã£ã“ï¼';
  else if(G.phase===5)m.textContent='ğŸ‚ ãŸã‚“ã˜ã‚‡ã†ã³ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ï¼';
}

// ============================================================
// EXP & LEVEL
// ============================================================
function gainExp(amount){
  G.exp+=amount;
  showExpPopup(amount);
  const leveled=[];
  while(G.exp>=G.expNext){G.exp-=G.expNext;G.level++;G.expNext=10;leveled.push(G.level)}
  updateHUD();
  if(leveled.length>0){
    playSfx('levelup');
    const lv=leveled[leveled.length-1];
    showDialogue('âœ¨','ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.'+lv+' ã«ãªã£ãŸï¼',()=>{hideDialogue();checkMonsterSpawn()});
  }
}

// ============================================================
// FIELD (PHASE 1)
// ============================================================
function tileW(){return window.innerWidth/G.fieldW}
function tileH(){return window.innerHeight/G.fieldH}

function buildField(){
  const bg=$('field-bg');bg.innerHTML='';
  const tw=tileW(),th=tileH(),w=window.innerWidth,h=window.innerHeight;
  const dark=Math.min(G.loop*0.08,0.4);
  $('field').style.background=`linear-gradient(180deg,rgba(${Math.max(0,135-G.loop*15)},${Math.max(0,206-G.loop*15)},${Math.max(0,235-G.loop*10)},1),rgba(${Math.max(0,152-G.loop*15)},${Math.max(0,251-G.loop*15)},${Math.max(0,152-G.loop*10)},1))`;
  if(dark>0){const ov=document.createElement('div');ov.style.cssText=`position:absolute;inset:0;background:rgba(0,0,0,${dark});pointer-events:none;z-index:1`;bg.appendChild(ov)}
  // Decorations
  const decs=['ğŸŒ¸','ğŸŒ³','ğŸŒ»','ğŸŒ¿','ğŸ’','ğŸ€'];
  for(let i=0;i<18;i++){const d=document.createElement('div');d.className='field-tile';d.style.left=Math.random()*(w-30)+'px';d.style.top=Math.random()*(h-30)+'px';d.textContent=decs[i%6];d.style.opacity=Math.max(0.3,0.7-G.loop*0.1);bg.appendChild(d)}
  // Eyes in background (loop 3+)
  if(G.loop>=3){for(let i=0;i<Math.min((G.loop-2)*3,12);i++){const e=document.createElement('div');e.className='field-tile';e.textContent='ğŸ‘ï¸';e.style.left=Math.random()*(w-30)+'px';e.style.top=Math.random()*(h-30)+'px';e.style.opacity='0';e.style.animation=`eyeBlink ${3+Math.random()*4}s infinite`;e.style.animationDelay=Math.random()*5+'s';e.style.fontSize='1.2rem';bg.appendChild(e)}}
  // Animals
  G.entities=[];
  ANIMALS.forEach((a,idx)=>{
    const el=document.createElement('div');
    el.className='field-entity animal-entity';
    el.textContent=a.emoji;
    el.style.left=a.x*tw+'px';el.style.top=a.y*th+'px';
    if(G.loop>=2)el.style.fontSize=(2.5+G.loop*0.3)+'rem';
    el.addEventListener('click',e=>{e.stopPropagation();talkToAnimal(idx)});
    bg.appendChild(el);
    G.entities.push({el,x:a.x,y:a.y});
  });
  // Hidden door
  const door=$('hidden-door');
  if(G.loop>=4){door.style.display='block';door.style.left=(G.fieldW-1)*tw+'px';door.style.top='0px';door.style.position='absolute';door.style.zIndex='15'}
  else door.style.display='none';
  updatePlayerPos();
}

function talkToAnimal(idx){
  if(G._talkCooldown||$('dialogue').style.display==='block')return;
  G._talkCooldown=true;setTimeout(()=>G._talkCooldown=false,500);
  const a=ANIMALS[idx];
  const lm=LOOP_MSGS[Math.min(G.loop+1,4)];
  const msg=lm?lm[idx%lm.length]:a.msg;
  playSfx('tap');
  showDialogue(a.emoji,msg,()=>{hideDialogue();if(G.petSelected)gainExp(5)});
}

function updatePlayerPos(){
  const tw=tileW(),th=tileH();
  $('player').style.left=G.playerX*tw+'px';$('player').style.top=G.playerY*th+'px';
  if(G.pet){
    $('pet-follow').style.display='block';$('pet-follow').textContent=PETS[G.pet].emoji;
    const px=G.playerX>0?G.playerX-1:G.playerX+1;
    $('pet-follow').style.left=px*tw+'px';$('pet-follow').style.top=G.playerY*th+'px';
  }
  // Auto-talk: if player steps on animal tile
  if(G.petSelected&&G.phase===1){
    G.entities.forEach((ent,idx)=>{
      if(ent.x===G.playerX&&ent.y===G.playerY)talkToAnimal(idx);
    });
  }
  // Hidden door check
  if(G.loop>=4&&G.playerX===G.fieldW-1&&G.playerY===0){playSfx('door');openLetterScreen()}
}

function movePlayer(dx,dy){
  if($('dialogue').style.display==='block')return; // don't move during dialogue
  const nx=G.playerX+dx,ny=G.playerY+dy;
  if(nx>=0&&nx<G.fieldW&&ny>=0&&ny<G.fieldH){G.playerX=nx;G.playerY=ny;updatePlayerPos()}
}

// D-Pad
['up','down','left','right'].forEach(dir=>{
  const btn=$('dpad-'+dir);
  const dirs={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]};
  const start=e=>{e.preventDefault();movePlayer(...dirs[dir]);G.moveInterval=setInterval(()=>movePlayer(...dirs[dir]),180)};
  const stop=e=>{e.preventDefault();if(G.moveInterval){clearInterval(G.moveInterval);G.moveInterval=null}};
  btn.addEventListener('touchstart',start,{passive:false});btn.addEventListener('mousedown',start);
  btn.addEventListener('touchend',stop,{passive:false});btn.addEventListener('touchcancel',stop,{passive:false});
  btn.addEventListener('mouseup',stop);btn.addEventListener('mouseleave',stop);
});
// Keyboard
document.addEventListener('keydown',e=>{
  const dirs={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0],w:[0,-1],s:[0,1],a:[-1,0],d:[1,0]};
  if(dirs[e.key]&&G.phase===1)movePlayer(...dirs[e.key]);
  if((e.key===' '||e.key==='Enter')&&$('dialogue').style.display!=='none'&&G.dialogueCallback)G.dialogueCallback();
});

// Action button = talk to nearest
$('action-btn').addEventListener('click',()=>{
  if($('dialogue').style.display==='block')return;
  let best=null,bestDist=999;
  G.entities.forEach((ent,idx)=>{
    const d=Math.abs(ent.x-G.playerX)+Math.abs(ent.y-G.playerY);
    if(d<=2&&d<bestDist){bestDist=d;best=idx}
  });
  if(best!==null)talkToAnimal(best);
  else showDialogue('','ã¡ã‹ãã« ã ã‚Œã‚‚ ã„ãªã„ã‚ˆã€‚\nã‚‚ã£ã¨ è¿‘ã¥ã„ã¦ã¿ã‚ˆã†ï¼',()=>hideDialogue());
});

// ============================================================
// PET SELECTION
// ============================================================
document.querySelectorAll('.pet-option').forEach(el=>{
  el.addEventListener('click',()=>{
    const id=el.dataset.pet;G.pet=id;G.petSelected=true;
    const p=PETS[id];G.petHP=p.hp;G.petMaxHP=p.hp;G.team=[id];
    playSfx('select');hide('pet-select');showBlock('field');
    show('hud');$('dpad').style.display='block';$('action-btn').style.display='block';
    $('pet-follow').style.display='block';$('pet-follow').textContent=p.emoji;
    updateHUD();updatePlayerPos();
    dialogueSequence([
      [p.emoji,p.name+'ãŒ ãªã‹ã¾ã«ãªã£ãŸï¼'],
      ['ğŸ‘§','å‹•ç‰©ã« è¿‘ã¥ãã¨ ã¯ãªã›ã‚‹ã‚ˆï¼ EXPã‚’ ãŸã‚ã‚ˆã†ï¼'],
    ],()=>gainExp(5));
  });
});

// ============================================================
// MONSTER SPAWN
// ============================================================
function checkMonsterSpawn(){
  setTimeout(()=>{
    if(G.phase!==1&&G.phase!==2)return; // safety
    const avail=MONSTERS.filter(m=>G.level>=m.lvReq&&!G.defeatedMonsters.includes(m.id));
    if(avail.length>0){
      const mon=avail[0];
      dialogueSequence([['âš ï¸','ç›®ã ã‚‰ã‘ã®æ€ªç£ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼'],['',mon.name+'ã ï¼ ãƒãƒˆãƒ«ã ï¼']],()=>startBattle(mon));
    }else if(G.defeatedMonsters.length>=3&&G.phase===1){
      setTimeout(()=>startPhase3(),500);
    }
  },400);
}

// ============================================================
// BATTLE (PHASE 2)
// ============================================================
function startBattle(mon){
  G.phase=2;G.battleActive=true;G.currentEnemy=mon;G.enemyHP=mon.hp;G.enemyMaxHP=mon.hp;G.petHP=G.petMaxHP;G._dodgeNext=false;
  hideAll();show('battle');startBGM('battle');
  const p=PETS[G.pet];
  $('enemy-emoji').textContent=mon.emoji;$('enemy-name').textContent=mon.name+' (Lv.'+mon.lvReq+')';
  $('pet-emoji').textContent=p.emoji;$('pet-name').textContent=p.name;
  updateBattleUI();$('battle-msg').textContent=mon.name+'ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼';
  setTimeout(showBattleActions,800);
}
function updateBattleUI(){
  const ep=Math.max(0,G.enemyHP/G.enemyMaxHP*100),pp=Math.max(0,G.petHP/G.petMaxHP*100);
  $('enemy-hp').style.width=ep+'%';$('enemy-hp').className='hp-fill'+(ep<30?' low':'');
  $('enemy-hp-text').textContent=Math.max(0,G.enemyHP)+'/'+G.enemyMaxHP;
  $('pet-hp').style.width=pp+'%';$('pet-hp').className='hp-fill'+(pp<30?' low':'');
  $('pet-hp-text').textContent=Math.max(0,G.petHP)+'/'+G.petMaxHP;
}
function showBattleActions(){
  const p=PETS[G.pet];
  $('battle-actions').innerHTML=`<button class="battle-btn atk" onclick="playerAttack('s1')">${p.skill1}</button><button class="battle-btn special" onclick="playerAttack('s2')">${p.skill2}</button>`;
}
function playerAttack(s){
  if(!G.battleActive)return;G.battleActive=false;
  const p=PETS[G.pet],m=G.currentEnemy;$('battle-actions').innerHTML='';
  if(s==='s1'){
    const dmg=Math.max(1,p.atk+Math.floor(Math.random()*4)-m.def/2);G.enemyHP-=dmg;playSfx('hit');
    $('battle-msg').textContent=p.name+'ã® '+p.skill1+'ï¼ '+dmg+'ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼';
  }else{
    switch(p.s2type){
      case'dodge':$('battle-msg').textContent=p.name+'ã¯ '+p.skill2+'ã§ èº«ã‚’ã‹ã‚ã™ä½“å‹¢ï¼';G._dodgeNext=true;break;
      case'buff':p.atk+=3;playSfx('heal');$('battle-msg').textContent=p.name+'ã® '+p.skill2+'ï¼ ã“ã†ã’ãåŠ›UPï¼';break;
      case'heal':const h=15;G.petHP=Math.min(G.petMaxHP,G.petHP+h);playSfx('heal');$('battle-msg').textContent=p.name+'ã® '+p.skill2+'ï¼ HP'+h+'å›å¾©ï¼';break;
    }
  }
  updateBattleUI();
  if(G.enemyHP<=0){setTimeout(battleVictory,1000);return}
  setTimeout(enemyAttack,1200);
}
function enemyAttack(){
  const m=G.currentEnemy,p=PETS[G.pet];
  if(G._dodgeNext){G._dodgeNext=false;$('battle-msg').textContent=m.name+'ã®ã“ã†ã’ãï¼ â€¦ã—ã‹ã—'+p.name+'ã¯ã‹ã‚ã—ãŸï¼';updateBattleUI();setTimeout(()=>{G.battleActive=true;showBattleActions()},1000);return}
  const dmg=Math.max(1,m.atk+Math.floor(Math.random()*3)-p.def/2);G.petHP-=dmg;playSfx('hit');
  $('battle-msg').textContent=m.name+'ã®ã“ã†ã’ãï¼ '+dmg+'ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼';updateBattleUI();
  if(G.petHP<=0){
    setTimeout(()=>{$('battle-msg').textContent=p.name+'ã¯ ãŸãŠã‚Œã¦ã—ã¾ã£ãŸâ€¦';
      setTimeout(()=>{G.petHP=Math.floor(G.petMaxHP*0.5);updateBattleUI();$('battle-msg').textContent=p.name+'ã¯ æ°—åˆã„ã§å¾©æ´»ï¼ ã‚‚ã†ä¸€åº¦ï¼';setTimeout(()=>{G.battleActive=true;showBattleActions()},1000)},1500);
    },1000);return}
  setTimeout(()=>{G.battleActive=true;showBattleActions()},1000);
}
function battleVictory(){
  stopBGM();playSfx('victory');spawnConfetti();
  const m=G.currentEnemy;G.defeatedMonsters.push(m.id);G.team.push(m.id);
  $('battle-msg').textContent=m.name+'ã‚’ ãŸãŠã—ãŸï¼';$('battle-actions').innerHTML='';
  setTimeout(()=>{
    dialogueSequence([['ğŸ‘ï¸â†’ğŸ˜Š','ãªã‹ã¾ã« ãªã‚ŠãŸã„â€¦'],['ğŸ‰',m.name+'ãŒ ãªã‹ã¾ã«ãªã£ãŸï¼'],['ğŸŠ','ã¿ã‚“ãªã§ ãŠã„ã‚ã„ï¼ğŸ°âœ¨']],()=>{
      spawnConfetti();hide('battle');
      if(G.defeatedMonsters.length>=3){gainExp(15);setTimeout(()=>startPhase3(),1500)}
      else{
        G.phase=1;showBlock('field');show('hud');$('dpad').style.display='block';$('action-btn').style.display='block';startBGM('field');
        gainExp(15); // This may trigger next monster via checkMonsterSpawn
      }
    });
  },1500);
}

// ============================================================
// PHASE 3: BIKE
// ============================================================
function startPhase3(){
  G.phase=3;G.bikeSection=0;stopBGM();
  transition(()=>{hideAll();
    dialogueSequence([['ğŸ‘§','ã¤ãã¯ ã¨ã‚‚ã ã¡ã« ã‚ã„ã«ã„ã“ã†ï¼'],['ğŸ‘§','ãƒã‚¤ã‚¯ã§ ã—ã‚…ã£ã±ã¤ï¼ğŸï¸']],()=>startBikeSection(0));
  });
}
function startBikeSection(sec){
  G.bikeSection=sec;G.bikeLane=1;G.bikeDistance=0;G.bikeTarget=60+sec*15;G.bikeObstacles=[];G.bikeRunning=true;
  hideAll();$('bike-scene').style.display='block';show('hud');G.phase=3;updateHUD();
  const bgs=['linear-gradient(180deg,#87CEEB,#90EE90)','linear-gradient(180deg,#FFB6C1,#FFF0F5)','linear-gradient(180deg,#DDA0DD,#E6E6FA)'];
  $('bike-scene').style.background=bgs[sec];$('bike-road').style.background='linear-gradient(0deg,#555,#777)';
  $('bike-road').innerHTML='';
  for(let i=0;i<3;i++){const l=document.createElement('div');l.style.cssText=`position:absolute;left:0;right:0;height:2px;border-top:2px dashed #fff;top:${(i+1)*25}%;opacity:0.5`;$('bike-road').appendChild(l)}
  const rt=window.innerHeight*0.6,lh=window.innerHeight*0.4/3;
  $('bike-player').style.left='15%';$('bike-player').style.top=rt+G.bikeLane*lh+'px';
  startBGM('bike');bikeLoop();
}
function bikeLoop(){
  if(!G.bikeRunning)return;
  G.bikeDistance+=0.5;$('bike-distance').textContent=Math.floor(G.bikeDistance)+'/'+G.bikeTarget+'m';
  if(Math.random()<0.03+G.bikeSection*0.01){
    const o=document.createElement('div');o.className='bike-obstacle';
    o.textContent=['ğŸª¨','ğŸŒ³','ğŸ“¦','ğŸš§'][Math.floor(Math.random()*4)];
    const lane=Math.floor(Math.random()*3),rt=window.innerHeight*0.6,lh=window.innerHeight*0.4/3;
    o.style.right='-40px';o.style.top=rt+lane*lh+'px';$('bike-scene').appendChild(o);G.bikeObstacles.push(o);
  }
  G.bikeObstacles.forEach(o=>{const r=parseInt(o.style.right)||0;o.style.right=(r+3+G.bikeSection)+'px'});
  G.bikeObstacles=G.bikeObstacles.filter(o=>{if(parseInt(o.style.right)>window.innerWidth+50){o.remove();return false}return true});
  const pr=$('bike-player').getBoundingClientRect();
  for(let i=G.bikeObstacles.length-1;i>=0;i--){
    const or=G.bikeObstacles[i].getBoundingClientRect();
    if(pr.right>or.left&&pr.left<or.right&&pr.bottom>or.top&&pr.top<or.bottom){
      playSfx('crash');G.bikeDistance=Math.max(0,G.bikeDistance-3);G.bikeObstacles[i].remove();G.bikeObstacles.splice(i,1);
      $('bike-player').style.opacity='0.5';setTimeout(()=>$('bike-player').style.opacity='1',400);
    }
  }
  if(G.bikeDistance>=G.bikeTarget){
    G.bikeRunning=false;stopBGM();G.bikeObstacles.forEach(o=>o.remove());G.bikeObstacles=[];
    setTimeout(()=>{hide('bike-scene');[visitYuna,visitHana,visitHi][G.bikeSection]()},500);return;
  }
  requestAnimationFrame(bikeLoop);
}
$('bike-up').addEventListener('click',()=>{if(G.bikeLane>0){G.bikeLane--;const rt=window.innerHeight*0.6,lh=window.innerHeight*0.4/3;$('bike-player').style.top=rt+G.bikeLane*lh+'px'}});
$('bike-down').addEventListener('click',()=>{if(G.bikeLane<2){G.bikeLane++;const rt=window.innerHeight*0.6,lh=window.innerHeight*0.4/3;$('bike-player').style.top=rt+G.bikeLane*lh+'px'}});

// ============================================================
// FRIEND VISITS
// ============================================================
function visitYuna(){
  G.friends.push('yuna');
  transition(()=>{hideAll();
    dialogueSequence([['ğŸ‘§ğŸª ã‚†ãªã¡ã‚ƒã‚“','ã²ã‹ã‚Šã¡ã‚ƒã‚“ï¼ ã‚ãã³ã«ãã¦ãã‚ŒãŸã®ï¼Ÿ'],['ğŸ‘§','ã‚†ãªã¡ã‚ƒã‚“ï¼ ãŠã‹ã—ã¤ãã‚ã†ï¼ğŸª']],()=>startMiniEvent('cookie'));
  });
}
function visitHana(){
  G.friends.push('hana');
  transition(()=>{hideAll();
    dialogueSequence([['ğŸ‘§ğŸŒ¸ ã¯ãªã¡ã‚ƒã‚“','ã¾ã£ã¦ãŸã‚ˆï¼ ãŠã¯ãªã¤ã¿ã—ã‚ˆã†ğŸŒ¸'],['ğŸ‘§','ã¯ãªã¡ã‚ƒã‚“ï¼ ãã‚Œã„ï¼']],()=>startMiniEvent('flower'));
  });
}
function visitHi(){
  G.friends.push('hi');
  transition(()=>{hideAll();
    dialogueSequence([['ğŸ‘§ğŸ€ ã²ãƒ¼ã¡ã‚ƒã‚“','ã¿ã‚“ãªã§ ã‚ã¤ã¾ã‚ã†ã‚ˆï¼'],['ğŸ‘§','ã²ãƒ¼ã¡ã‚ƒã‚“ï¼ ã¿ã‚“ãª ã„ã£ã—ã‚‡ã ã­ï¼']],()=>{spawnConfetti();setTimeout(startPhase4,1500)});
  });
}

// ============================================================
// MINI EVENTS
// ============================================================
function startMiniEvent(type){
  show('mini-event');const c=$('mini-event-content');
  if(type==='cookie'){
    $('mini-event').style.background='linear-gradient(180deg,#FFE4B5,#DEB887)';
    c.innerHTML='<h2 style="color:#fff">ğŸª ãŠã‹ã—ã¥ãã‚Š ğŸª</h2><p style="color:#fff">ã‚¿ãƒƒãƒ—ã—ã¦ãŠã‹ã—ã‚’ã¤ãã‚ã†ï¼</p><div id="cc" style="font-size:2rem;color:#fff;margin:15px 0">0/5</div><button class="btn btn-primary" id="ct" style="font-size:2rem;padding:18px 36px">ğŸª ã¾ãœã‚‹ï¼</button>';
    let n=0;$('ct').onclick=()=>{n++;playSfx('tap');$('cc').textContent=n+'/5';
      if(n>=5){$('ct').disabled=true;setTimeout(()=>{hide('mini-event');spawnConfetti();
        dialogueSequence([['ğŸ‘§ğŸª','ãŠã‹ã—ã§ããŸã‚ˆï¼ğŸªâœ¨'],['','ã‚†ãªã¡ã‚ƒã‚“ãŒ ãªã‹ã¾ã«ãªã£ãŸï¼']],()=>startWaitCounter());
      },500)}};
  }else if(type==='flower'){
    $('mini-event').style.background='linear-gradient(180deg,#FFB6C1,#FFC0CB)';
    c.innerHTML='<h2 style="color:#fff">ğŸŒ¸ ãŠã¯ãªã¤ã¿ ğŸŒ¸</h2><p style="color:#fff">ãŠã¯ãªã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚ã¤ã‚ã‚ˆã†ï¼</p><div id="fc" style="font-size:1.2rem;color:#fff;margin:8px 0">0/10</div><div id="ff" style="position:relative;width:90%;height:250px;margin:0 auto"></div>';
    let n=0;const ff=$('ff');
    function sf(){const f=document.createElement('div');f.style.cssText=`position:absolute;font-size:2.5rem;cursor:pointer;left:${Math.random()*80}%;top:${Math.random()*80}%`;f.textContent=['ğŸŒ¸','ğŸŒº','ğŸŒ»','ğŸŒ·','ğŸ’'][Math.floor(Math.random()*5)];
      f.onclick=()=>{n++;playSfx('tap');f.remove();$('fc').textContent=n+'/10';if(n<10)sf();else setTimeout(()=>{hide('mini-event');spawnConfetti();dialogueSequence([['ğŸ‘§ğŸŒ¸','ã„ã£ã±ã„ã‚ã¤ã¾ã£ãŸã­ï¼ğŸŒ¸âœ¨'],['','ã¯ãªã¡ã‚ƒã‚“ãŒ ãªã‹ã¾ã«ãªã£ãŸï¼']],()=>startBikeSection(2))},500)};
      ff.appendChild(f)}
    for(let i=0;i<5;i++)sf();
  }
}
function startWaitCounter(){
  show('wait-counter');let n=5;$('wait-timer').textContent=n;
  const iv=setInterval(()=>{n--;$('wait-timer').textContent=n;
    if(n<=0){clearInterval(iv);G.canTransform=true;playSfx('levelup');hide('wait-counter');
      dialogueSequence([['âœ¨','å¤‰èº«ã®åŠ›ãŒã‚ã–ã‚ãŸï¼'],['âœ¨',PETS[G.pet].emoji+'ã«å¤‰èº«ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸï¼']],()=>{G.transformed=true;startBikeSection(1)});
    }
  },1000);
}

// ============================================================
// PHASE 4: GARDEN
// ============================================================
function startPhase4(){
  G.phase=4;stopBGM();
  transition(()=>{hideAll();startBGM('garden');show('garden');show('hud');updateHUD();
    $('garden').style.background='linear-gradient(180deg,#87CEEB,#90EE90)';
    $('garden-content').innerHTML='<h2 style="color:#fff">ğŸ¡ ãŠã«ã‚ã§ã‚ãã¼ã†ï¼ ğŸŒ³</h2><p style="color:#fff;font-size:1rem">ğŸƒ ã‹ã‘ã£ã“ï¼ ã‚¿ãƒƒãƒ—ã‚Œã‚“ã ã§ã¯ã—ã‚Œï¼</p><div style="font-size:2rem;margin:12px 0"><span id="rh" style="display:inline-block">ğŸ‘§</span> <span style="margin-left:15px">ğŸ‘§ğŸªğŸ‘§ğŸŒ¸ğŸ‘§ğŸ€</span></div><div style="width:80%;max-width:300px;height:20px;background:rgba(255,255,255,0.3);border-radius:10px;margin:12px auto;overflow:hidden"><div id="rf" style="width:0%;height:100%;background:linear-gradient(90deg,#FF6B9D,#FF9A76);border-radius:10px;transition:width 0.1s"></div></div><div id="rt" style="color:#fff;font-size:0.9rem">ã‚¿ãƒƒãƒ—ã—ã¦ ã¯ã—ã‚ã†ï¼</div><button class="btn btn-primary" id="rb" style="margin-top:12px;font-size:1.5rem;padding:14px 36px">ğŸƒ ã¯ã—ã‚‹ï¼</button>';
    let prog=0;
    $('rb').onclick=()=>{prog+=2;playSfx('tap');$('rf').style.width=Math.min(100,prog)+'%';$('rh').style.transform=`translateX(${prog}px)`;
      const t=Math.min(1,prog/100);
      $('garden').style.background=`linear-gradient(180deg,rgb(${Math.floor(135+t*120)},${Math.floor(206-t*100)},${Math.floor(235-t*150)}),rgb(${Math.floor(144+t*60)},${Math.floor(238-t*100)},${Math.floor(144-t*50)}))`;
      if(prog>=100){$('rb').disabled=true;$('rt').textContent='ã‚´ãƒ¼ãƒ«ï¼ğŸ‰';spawnConfetti();
        setTimeout(()=>dialogueSequence([['ğŸ‰','ã¿ã‚“ãªã§ãŸã®ã—ãã‚ãã‚“ã ï¼'],['ğŸ‘§ğŸŒ¸ ã¯ãªã¡ã‚ƒã‚“','ã‚‚ã† ã‚†ã†ãŒãŸã‹ãâ€¦ğŸŒ…'],['ğŸ‘§ğŸ€ ã²ãƒ¼ã¡ã‚ƒã‚“','ã¤ãã¯â€¦ã²ã‹ã‚Šã¡ã‚ƒã‚“ã® ãŸã‚“ã˜ã‚‡ã†ã³ã ã‚ˆï¼ğŸ‚']],()=>{stopBGM();setTimeout(startPhase5,1000)}),1000);
      }};
  });
}

// ============================================================
// PHASE 5: BIRTHDAY â†’ HORROR
// ============================================================
function startPhase5(){
  G.phase=5;
  transition(()=>{hideAll();show('birthday');show('hud');updateHUD();
    $('birthday').style.background='linear-gradient(180deg,#1a1a2e,#16213e)';startBGM('birthday');
    $('birthday-content').innerHTML='<div style="font-size:1.5rem;color:#fff;margin-bottom:15px">ğŸŒ™ ã‚ˆã‚‹ã«ãªã‚Šã¾ã—ãŸ</div><div style="font-size:1rem;color:#ddd;margin-bottom:25px">ãŠã¸ã‚„ã«ã¿ã‚“ãªãŒã‚ã¤ã¾ã£ã¦ã„ã¾ã™</div><div style="font-size:1.2rem;color:#FFD700;margin-bottom:15px">ã€Œã²ã‹ã‚Šã¡ã‚ƒã‚“ã€<br>ãŠãŸã‚“ã˜ã‚‡ã†ã³ ãŠã‚ã§ã¨ã†ï¼ğŸ‚ğŸ‰ã€</div><div style="margin:15px 0"><span class="candle">ğŸ•¯ï¸</span><span style="font-size:3rem">ğŸ‚</span><span class="candle">ğŸ•¯ï¸</span></div><p style="color:#ccc;margin-bottom:12px">ã‚ã†ããã‚’ ãµãã‘ãã†ï¼</p><button class="btn btn-primary" id="blow-btn">ãµãƒ¼ã£ï¼ğŸŒ¬ï¸</button>';
    $('blow-btn').onclick=()=>{playSfx('tap');
      document.querySelectorAll('.candle').forEach(c=>{c.style.animation='none';c.style.opacity='0.3'});
      spawnConfetti();$('blow-btn').remove();
      setTimeout(()=>{$('birthday-content').innerHTML+='<div style="color:#FFD700;font-size:1.2rem;margin-top:15px">ã€Œãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã ã‚ˆï¼ ã‚ã‘ã¦ï¼ğŸã€</div><div id="present-box" style="margin-top:15px">ğŸ</div>';
        $('present-box').onclick=openPresent;
      },1500);
    };
  });
}
function openPresent(){
  stopBGM();$('present-box').style.animation='none';$('present-box').textContent='ğŸ“¦';
  hide('hud');
  setTimeout(()=>{
    $('birthday-content').innerHTML='<div style="font-size:4rem;margin-bottom:15px">â¤ï¸</div><div style="color:#f00;font-size:1.2rem;line-height:1.8">ãªã‹ã«ã¯ ã¿ã‚“ãªã®<br><span style="font-size:1.5rem;font-weight:bold">å¿ƒè‡“ãŒ ã¯ã„ã£ã¦ã„ãŸ</span></div>';
    $('horror-overlay').classList.add('active');$('birthday').style.background='linear-gradient(180deg,#2d0000,#1a0000)';
    const hb=setInterval(()=>playSfx('heartbeat'),1500);
    setTimeout(()=>dialogueSequence([['ğŸ‘§','â€¦ãˆï¼Ÿ'],['','ã¨ã‚‚ã ã¡ã®ã™ãŒãŸãŒ ããˆã¦ã„ã‚‹'],['','ãƒšãƒƒãƒˆãŸã¡ã‚‚ ããˆã¦ã„ã‚‹'],['ğŸ‘§','ã“ã‚Œã¯â€¦ã¿ã‚“ãªã®â€¦ï¼Ÿ']],()=>{clearInterval(hb);setTimeout(startEscape,1000)}),2000);
  },1500);
}

// ============================================================
// ESCAPE
// ============================================================
function startEscape(){
  hideAll();$('horror-overlay').classList.remove('active');show('escape');startBGM('escape');
  $('escape').querySelectorAll('.escape-eye').forEach(e=>e.remove());
  for(let i=0;i<5+G.loop*3;i++){const e=document.createElement('div');e.className='escape-eye';e.textContent='ğŸ‘ï¸';e.style.left=(20+Math.random()*70)+'%';e.style.top=(10+Math.random()*70)+'%';e.style.animationDelay=Math.random()*5+'s';e.style.animationDuration=(2+Math.random()*3)+'s';$('escape').appendChild(e)}
  const si=setInterval(()=>playNote(100+Math.random()*50,0.1,'triangle',0.08),400);
  setTimeout(()=>{clearInterval(si);stopBGM();startLoop()},8000);
}

// ============================================================
// LOOP
// ============================================================
function startLoop(){
  G.loop++;hideAll();show('loop-msg');
  let html='<p style="font-size:0.9rem;opacity:0.5">â€¦</p><p style="margin:15px 0">ã‚ã•ã«ãªã£ã¦ã„ã‚‹ã€‚</p><p>ã©ã†ã¶ã¤ãŸã¡ãŒã„ã‚‹ã€‚ã¨ã‚‚ã ã¡ã‚‚ã„ã‚‹ã€‚</p><p style="margin-top:15px">ãªã«ã”ã¨ã‚‚ ãªã‹ã£ãŸã‹ã®ã‚ˆã†ã«ã€‚</p><p style="font-size:0.85rem;color:#aaa;margin-top:25px">ã€Œã“ã“ã«ã¯ãŸãã•ã‚“ã®ã©ã†ã¶ã¤ãŒã„ã¾ã™ã€‚<br>ã¿ã‚“ãªã§ãŸã®ã—ãã™ã”ã—ã¦ã„ã¾ã™ã€‚ã€</p><button class="btn btn-primary" id="loop-continue" style="margin-top:25px">ã¤ã¥ã‘ã‚‹</button><p style="font-size:0.8rem;color:#666;margin-top:10px">ã€œ '+(G.loop+1)+'ã—ã‚…ã†ã‚ ã€œ</p>';
  if(G.loop>=3)html+='<p style="font-size:0.75rem;color:#800;margin-top:10px">ã€Œã“ã‚Œã¯ãšã£ã¨ã¤ã¥ãã¾ã™ã€‚ãŸã®ã—ãã‚„ã£ã¦ãã ã•ã„ã­ğŸ˜Šã€</p>';
  $('loop-msg').innerHTML=html;
  $('loop-continue').onclick=()=>{playSfx('tap');transition(()=>{resetForLoop();startPhase1()})};
}
function resetForLoop(){
  G.phase=0;G.level=1;G.exp=0;G.expNext=10;G.pet=null;G.petHP=0;G.petMaxHP=0;
  G.petSelected=false;G.team=[];G.friends=[];G.transformed=false;G.canTransform=false;
  G.defeatedMonsters=[];G.playerX=5;G.playerY=4;G.battleActive=false;G._dodgeNext=false;G._talkCooldown=false;
}

// ============================================================
// LETTER / TRUE ENDING
// ============================================================
function openLetterScreen(){
  hideAll();show('letter-screen');playSfx('door');stopBGM();
  $('letter-content').innerHTML='<p style="font-weight:bold;margin-bottom:12px">ğŸ“œ ã¦ãŒã¿</p><p>ã²ã‹ã‚Šã¡ã‚ƒã‚“ã¸ã€‚</p><p style="margin-top:8px">ã“ã‚Œã¯ ã‚†ã‚ã§ã™ã€‚</p><p>ã‚ã‚’ ã•ã¾ã—ã¦ãã ã•ã„ã€‚</p><p style="margin-top:12px;color:#888">ã€Œã¯ã“ã‚’ ã‚ã‘ãªã‘ã‚Œã°<br>ã‚ˆã‹ã£ãŸã®ã«ã€‚ã€</p>';
  $('letter-choices').innerHTML='<button class="btn btn-primary" id="choice-wake">A: ã‚ã‚’ ã•ã¾ã™</button><button class="btn btn-secondary" id="choice-stay">B: ã‚†ã‚ã®ãªã‹ã«ã„ã‚‹</button>';
  $('choice-wake').onclick=()=>{playSfx('select');trueEnding()};
  $('choice-stay').onclick=()=>{playSfx('tap');hide('letter-screen');showBlock('field');show('hud');$('dpad').style.display='block';$('action-btn').style.display='block';startBGM('field');G.playerX=5;G.playerY=4;updatePlayerPos();updateHUD()};
}
function trueEnding(){
  hideAll();show('true-ending');$('true-ending').style.background='linear-gradient(180deg,#FFE4B5,#FFF8DC)';stopBGM();
  setTimeout(()=>[523,587,659,784,880,1047].forEach((f,i)=>setTimeout(()=>playNote(f,0.5,'sine',0.08),i*300)),1000);
  $('true-ending').innerHTML='<h2 style="color:#333;margin-bottom:15px">âœ¨ çœŸã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° âœ¨</h2><p style="color:#555">ã²ã‹ã‚Šã¡ã‚ƒã‚“ã¯ ã‚ã‚’ã•ã¾ã—ãŸã€‚</p><p style="color:#555;margin-top:12px">ã€Œã‚†ãªã¡ã‚ƒã‚“ï¼ ã¯ãªã¡ã‚ƒã‚“ï¼ ã²ãƒ¼ã¡ã‚ƒã‚“ï¼<br>â€¦ã‚ˆã‹ã£ãŸã€ã¿ã‚“ãª ã„ã‚‹ã€</p><p style="color:#333;margin-top:15px">ğŸ‘§ğŸªã€Œã²ã‹ã‚Šã¡ã‚ƒã‚“ ãŠã¯ã‚ˆã†ï¼<br>ãã‚‡ã†ã¯ ãŠãŸã‚“ã˜ã‚‡ã†ã³ã ã‚ˆğŸ‚ã€</p><div style="font-size:3rem;margin:15px 0">ğŸ‚âœ¨ğŸ‰</div><p style="color:#555">ã“ã‚“ã©ã¯ ã»ã‚“ã‚‚ã®ã® ãŸã‚“ã˜ã‚‡ã†ã³ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã€‚</p><p style="color:#555;margin-top:8px">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã® ã¯ã“ã‚’ ã‚ã‘ã‚‹ã¨â€¦</p><div style="font-size:3rem;margin:12px 0">ğŸ§¸</div><p style="color:#333;font-size:1.1rem;font-weight:bold">ã‹ã‚ã„ã„ ãƒšãƒƒãƒˆã® ã¬ã„ãã‚‹ã¿ãŒ ã¯ã„ã£ã¦ã„ãŸï¼</p><p style="color:#FF6B9D;font-size:1.3rem;font-weight:bold;margin-top:15px">ã€Œãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ï¼ğŸ‰ã€</p><button class="btn btn-primary" id="true-end-btn" style="margin-top:20px">ãŠã‚ã‚Š</button>';
  spawnConfetti();setTimeout(spawnConfetti,1500);
  $('true-end-btn').onclick=()=>location.reload();
}

// ============================================================
// HIDE ALL & START
// ============================================================
function hideAll(){
  ['field','hud','battle','bike-scene','mini-event','wait-counter','garden','birthday','escape','loop-msg','letter-screen','true-ending','pet-select','dialogue'].forEach(id=>$(id).style.display='none');
  $('dpad').style.display='none';$('action-btn').style.display='none';$('horror-overlay').classList.remove('active');
}
$('start-btn').addEventListener('click',()=>{initAudio();playSfx('select');hide('title-screen');startPhase1()});

function startPhase1(){
  G.phase=1;hideAll();showBlock('field');buildField();startBGM('field');
  // Always show pet select (fresh or loop)
  dialogueSequence([['','ã“ã“ã«ã¯ ãŸãã•ã‚“ã® ã©ã†ã¶ã¤ãŒ ã„ã¾ã™ã€‚'],['','ã¿ã‚“ãªã§ ãŸã®ã—ã ã™ã”ã—ã¦ã„ã¾ã™ã€‚'],['','ã¾ãšã¯ ãƒšãƒƒãƒˆã‚’ ãˆã‚‰ã¼ã†ï¼']],()=>show('pet-select'));
}

window.addEventListener('resize',()=>{if(G.phase===1&&$('field').style.display!=='none')buildField()});
</script>
</body>
</html>
